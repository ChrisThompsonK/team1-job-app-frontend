{% extends "layouts/base.njk" %}
{% set currentPage = "job-roles" %}
{% block title %}
    Apply for {{ jobRole.name }}
{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="/css/job-roles.css">
{% endblock %}
{% block body_attributes %}
    class="job-application-page"{% endblock %}
{% block main_attributes %}
    class="container mx-auto px-4 py-8"{% endblock %}
{% block content %}
    <!-- Breadcrumb Navigation -->
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="/" class="link link-hover">{{ t('nav.home') }}</a></li>
            <li><a href="/job-roles" class="link link-hover">{{ t('nav.jobRoles') }}</a></li>
            <li><a href="/job-roles/{{ jobRole.id }}" class="link link-hover">{{ jobRole.name }}</a></li>
            <li class="text-base-content/70">{{ t('jobApplication.title') }}</li>
        </ul>
    </div>

    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center gap-4 mb-4">
            <a href="/job-roles/{{ jobRole.id }}" class="btn btn-ghost btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                {{ t('common.back') }}
            </a>
        </div>
        <h1 class="text-4xl font-bold text-base-content mb-2">{{ t('jobApplication.title') }}</h1>
        <p class="text-base-content/70">{{ t('jobApplication.subtitle') }} {{ jobRole.name }}</p>
    </div>

    <!-- Job Summary Card -->
    <div class="card bg-base-100 shadow-lg mb-8">
        <div class="card-body">
            <h2 class="card-title text-lg text-primary mb-4">{{ t('jobApplication.jobSummary') }}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <span class="text-base-content/80">{{ jobRole.location }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0V6a2 2 0 012 2v6.5"></path>
                    </svg>
                    <span class="text-base-content/80">{{ jobRole.capability }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                    </svg>
                    <span class="text-base-content/80">{{ jobRole.band }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-base-content/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-base-content/80">{{ t('jobRoles.closes') }}: {{ jobRole.closingDate.toLocaleDateString() }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Form -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <h2 class="card-title text-lg text-primary mb-6">{{ t('jobApplication.formTitle') }}</h2>
            
            <!-- Error Alert -->
            {% if error %}
            <div class="alert alert-error mb-6">
                <svg class="w-6 h-6 shrink-0 stroke-current" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>{{ error }}</span>
            </div>
            {% endif %}

            <form id="jobApplicationForm" method="POST" action="/job-roles/{{ jobRole.id }}/apply">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Personal Information Section -->
                    <div class="col-span-2">
                        <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            {{ t('jobApplication.personalInfo') }}
                        </h3>
                        <div class="divider"></div>
                    </div>

                    <!-- First Name -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.firstName') }} *</span>
                        </label>
                        <input type="text" name="firstName" id="firstName" class="input input-bordered" 
                               value="{{ formData.firstName if formData else '' }}" required/>
                    </div>

                    <!-- Last Name -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.lastName') }} *</span>
                        </label>
                        <input type="text" name="lastName" id="lastName" class="input input-bordered" 
                               value="{{ formData.lastName if formData else '' }}" required/>
                    </div>

                    <!-- Email -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.email') }} *</span>
                        </label>
                        <input type="email" name="email" id="email" class="input input-bordered" 
                               value="{{ formData.email if formData else '' }}" required/>
                    </div>

                    <!-- Phone -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.phone') }} *</span>
                        </label>
                        <input type="tel" name="phone" id="phone" class="input input-bordered" 
                               value="{{ formData.phone if formData else '' }}" required/>
                    </div>

                    <!-- Address -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.address') }} *</span>
                        </label>
                        <textarea name="address" id="address" class="textarea textarea-bordered h-24" 
                                  required>{{ formData.address if formData else '' }}</textarea>
                    </div>

                    <!-- Documents Section -->
                    <div class="col-span-2 mt-6">
                        <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            {{ t('jobApplication.documents') }}
                        </h3>
                        <div class="divider"></div>
                    </div>

                    <!-- CV Upload -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.cv') }} *</span>
                        </label>
                        <input type="file" name="cv" id="cv" 
                               class="file-input file-input-bordered w-full" 
                               accept=".pdf,.doc,.docx" required/>
                        <div class="label">
                            <span class="label-text-alt">{{ t('jobApplication.cvHint') }}</span>
                        </div>
                    </div>

                    <!-- Cover Letter Upload -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.coverLetter') }}</span>
                        </label>
                        <input type="file" name="coverLetter" id="coverLetter" 
                               class="file-input file-input-bordered w-full" 
                               accept=".pdf,.doc,.docx"/>
                        <div class="label">
                            <span class="label-text-alt">{{ t('jobApplication.coverLetterHint') }}</span>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="col-span-2 mt-6">
                        <h3 class="text-lg font-semibold text-base-content mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            {{ t('jobApplication.additionalInfo') }}
                        </h3>
                        <div class="divider"></div>
                    </div>

                    <!-- Why interested -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.whyInterested') }} *</span>
                        </label>
                        <textarea name="whyInterested" id="whyInterested" 
                                  class="textarea textarea-bordered h-32" 
                                  placeholder="{{ t('jobApplication.whyInterestedPlaceholder') }}" 
                                  required>{{ formData.whyInterested if formData else '' }}</textarea>
                    </div>

                    <!-- Relevant Experience -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.relevantExperience') }} *</span>
                        </label>
                        <textarea name="relevantExperience" id="relevantExperience" 
                                  class="textarea textarea-bordered h-32" 
                                  placeholder="{{ t('jobApplication.relevantExperiencePlaceholder') }}" 
                                  required>{{ formData.relevantExperience if formData else '' }}</textarea>
                    </div>

                    <!-- Additional Comments -->
                    <div class="form-control col-span-2">
                        <label class="label">
                            <span class="label-text font-medium">{{ t('jobApplication.additionalComments') }}</span>
                        </label>
                        <textarea name="additionalComments" id="additionalComments" 
                                  class="textarea textarea-bordered h-24" 
                                  placeholder="{{ t('jobApplication.additionalCommentsPlaceholder') }}">{{ formData.additionalComments if formData else '' }}</textarea>
                    </div>

                    <!-- Consent and Agreement -->
                    <div class="col-span-2 mt-6">
                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" name="dataConsent" id="dataConsent" class="checkbox checkbox-primary" required/>
                                <span class="label-text">{{ t('jobApplication.dataConsent') }} *</span>
                            </label>
                        </div>
                        <div class="form-control mt-2">
                            <label class="label cursor-pointer justify-start gap-4">
                                <input type="checkbox" name="marketingConsent" id="marketingConsent" class="checkbox checkbox-primary"/>
                                <span class="label-text">{{ t('jobApplication.marketingConsent') }}</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end gap-4 mt-8">
                    <a href="/job-roles/{{ jobRole.id }}" class="btn btn-outline">{{ t('common.cancel') }}</a>
                    <button type="submit" class="btn btn-primary gap-2" id="submitBtn">
                        <span class="loading loading-spinner loading-sm hidden" id="loadingSpinner"></span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        {{ t('jobApplication.submitApplication') }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Message -->
    {% if success %}
    <div class="alert alert-success mt-6">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>{{ success }}</span>
    </div>
    {% endif %}

{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('jobApplicationForm');
            const submitBtn = document.getElementById('submitBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');

            form.addEventListener('submit', function (event) {
                // Show loading state
                submitBtn.disabled = true;
                loadingSpinner.classList.remove('hidden');
            });

            // Form validation
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                field.addEventListener('invalid', function () {
                    this.classList.add('input-error');
                });
                field.addEventListener('input', function () {
                    if (this.validity.valid) {
                        this.classList.remove('input-error');
                    }
                });
            });

            // Auto-resize textareas
            const textareas = form.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });

            // File upload validation
            const cvInput = document.getElementById('cv');
            const coverLetterInput = document.getElementById('coverLetter');

            function validateFileSize(input, maxSizeMB = 5) {
                if (input.files.length > 0) {
                    const file = input.files[0];
                    const maxSize = maxSizeMB * 1024 * 1024; // Convert to bytes
                    
                    if (file.size > maxSize) {
                        alert(`File size must be less than ${maxSizeMB}MB`);
                        input.value = '';
                        return false;
                    }
                }
                return true;
            }

            cvInput.addEventListener('change', function() {
                validateFileSize(this);
            });

            coverLetterInput.addEventListener('change', function() {
                validateFileSize(this);
            });

            // Character count for textareas
            function setupCharacterCount(textareaId, maxLength = 500) {
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    const parent = textarea.parentElement;
                    const counter = document.createElement('div');
                    counter.className = 'label mt-1';
                    counter.innerHTML = `<span class="label-text-alt"><span id="${textareaId}-count">0</span> / ${maxLength} characters</span>`;
                    parent.appendChild(counter);

                    const countSpan = document.getElementById(`${textareaId}-count`);
                    
                    textarea.addEventListener('input', function() {
                        const length = this.value.length;
                        countSpan.textContent = length;
                        
                        if (length > maxLength * 0.9) {
                            countSpan.parentElement.classList.add('text-warning');
                        } else {
                            countSpan.parentElement.classList.remove('text-warning');
                        }
                    });
                }
            }

            setupCharacterCount('whyInterested', 500);
            setupCharacterCount('relevantExperience', 500);
            setupCharacterCount('additionalComments', 300);
        });
    </script>
{% endblock %}